# مستندات فنی جامع: سیستم حسابداری بازرگانی فرش

**آخرین بروزرسانی:** ۲۰۲۵/۰۸/۰۳

## ۱. نمای کلی و اهداف پروژه

این پروژه یک سیستم حسابداری تحت وب برای مدیریت عملیات بازرگانی فرش است. هدف اصلی آن، فراهم کردن ابزاری یکپارچه برای مدیریت فاکتورهای خرید و فروش، انبار و محصولات، هزینه‌ها، چک‌ها، شرکا و گزارش‌گیری‌های مالی است. برنامه با رویکرد مدرن (Single Page Application-like) طراحی شده که در آن بارگذاری مجدد صفحه به حداقل رسیده و تعاملات کاربر از طریق AJAX انجام می‌شود.

-----

## ۲. پشته فنی (Tech Stack)

  * **سمت سرور (Backend):**

      * **زبان:** PHP (نسخه سازگار با `call_user_func_array` برای `bind_param`)
      * **دیتابیس:** MySQL / MariaDB
      * **محیط سرور:** نیازمند وب سرور Apache یا Nginx با پشتیبانی از PHP.
      * **نکته مهم:** به دلیل عدم پشتیبانی سرور از درایور `mysqlnd`، تمام کدهای دیتابیس با استفاده از روش سازگارتر `bind_result` به جای `get_result` نوشته شده‌اند تا از بروز خطا جلوگیری شود.

  * **سمت کاربر (Frontend):**

      * **زبان‌ها:** HTML5, CSS3, JavaScript (ES6)
      * **کتابخانه‌ها:**
          * **jQuery:** برای دستکاری DOM و مدیریت رویدادها.
          * **Bootstrap 5:** برای طراحی رابط کاربری واکنش‌گرا (Responsive).
          * **Select2:** برای ایجاد dropdownهای قابل جستجو.
          * **Persian Datepicker:** برای انتخاب تاریخ شمسی.
          * **DataTables.js:** برای افزودن قابلیت‌های پیشرفته (جستجو، صفحه‌بندی، مرتب‌سازی) به جداول.

-----

## ۳. معماری برنامه

برنامه از یک معماری دو لایه کلاینت-سرور پیروی می‌کند:

  * **کلاینت (Frontend):** یک صفحه اصلی (`index.html`) که تمام رابط کاربری را در خود جای داده است. ناوبری بین بخش‌های مختلف از طریق تب‌های بوت‌استرپ انجام می‌شود و تمام درخواست‌های داده از طریق AJAX به بک‌اند ارسال می‌گردد. کدهای جاوا اسکریپت به صورت ماژولار سازماندهی شده‌اند تا مدیریت و توسعه آن‌ها آسان باشد.

  * **سرور (Backend):** یک API تقریباً RESTful که از طریق فایل `api.php` در دسترس است. این API از الگوی **Router-Controller-Model** برای مدیریت درخواست‌ها استفاده می‌کند:

    1.  **Router (`api/index.php`):** نقطه ورود تمام درخواست‌هاست. این فایل بر اساس پارامتر `action`، درخواست را به کنترلر و متد مناسب هدایت می‌کند.
    2.  **Controller (`api/controllers/`):** لایه منطقی برنامه است. کنترلرها درخواست را دریافت کرده، داده‌های ورودی را اعتبارسنجی می‌کنند و متدهای مناسب از مدل‌ها را فراخوانی می‌نمایند.
    3.  **Model (`api/models/`):** لایه دسترسی به داده‌هاست. تمام کوئری‌های SQL و تعاملات با دیتابیس در این لایه انجام می‌شود.

-----

## ۴. ساختار فایل‌ها و تشریح نقش هر فایل

### الف) ساختار فرانت‌اند

```
/ (root)
|-- index.html
|-- style.css
|-- js/
|   |-- app.js
|   |-- api.js
|   |-- auth.js
|   |-- config.js
|   |-- dashboard.js
|   |-- entity-manager.js
|   |-- invoice-manager.js
|   |-- partner-manager.js
|   |-- account-manager.js
|   |-- reports.js
|   |-- ui.js
```

  * **`index.html`**: فایل اصلی که ساختار کلی UI، تمام تب‌ها، مودال‌ها و جداول را در خود دارد. تمام فایل‌های JS و CSS در این فایل بارگذاری می‌شوند.
  * **`style.css`**: شامل تمام استایل‌های سفارشی برنامه.
  * **`js/config.js`**: شامل تنظیمات ثابت جاوا اسکریپت مانند آدرس API، وضعیت اولیه جداول برای صفحه‌بندی و لیست دسته‌بندی هزینه‌ها.
  * **`js/api.js`**: یک ماژول برای مدیریت تمام تماس‌های AJAX (fetch) به بک‌اند.
  * **`js/ui.js`**: شامل توابع کمکی برای رابط کاربری، مانند نمایش/مخفی کردن لودر، فرمت‌دهی ارز، مودال تایید حذف و قالب‌بندی اعداد در لحظه تایپ.
  * **`js/auth.js`**: مسئول تمام فرآیندهای مربوط به احراز هویت.
  * **`js/app.js`**: **ارکستریتور اصلی برنامه**. این فایل تمام ماژول‌های دیگر را مقداردهی اولیه کرده، `appCache` (شامل لیست مشتریان، حساب‌ها و...) را مدیریت می‌کند و رویدادهای اصلی مانند کلیک روی تب‌ها را کنترل می‌نماید.
  * **`js/dashboard.js`**: منطق مربوط به بارگذاری و نمایش داده‌ها در تب داشبورد.
  * **`js/entity-manager.js`**: یک ماژول **عمومی** و هوشمند برای مدیریت موجودیت‌های ساده (مشتریان، تامین‌کنندگان، محصولات، هزینه‌ها و...).
  * **`js/partner-manager.js`**: ماژول اختصاصی برای تب "شرکا" که قابلیت ویرایش تراکنش‌ها را نیز مدیریت می‌کند.
  * **`js/account-manager.js`**: ماژول اختصاصی برای تب "بانک‌ها و صندوق". مسئولیت نمایش لیست حساب‌ها و گردش حساب هر کدام را بر عهده دارد.
  * **`js/invoice-manager.js`**: **پیچیده‌ترین ماژول فرانت‌اند**. مسئول تمام منطق مربوط به فاکتورهای خرید و فروش، از جمله مدیریت مودال‌ها، فیلد تخفیف، انتخاب حساب برای پرداخت‌های نقدی و استفاده از `select2` برای انتخاب اشخاص و محصولات.
  * **`js/reports.js`**: ماژول مستقل برای تولید و چاپ گزارشات مالی، شامل گزارش سود و زیان پیشرفته و صورتحساب اشخاص و بانک‌ها.

### ب) ساختار بک‌اند

```
/ (root)
|-- api.php
|-- api/
|   |-- index.php
|   |-- config.php
|   |-- core/
|   |   |-- helpers.php
|   |-- controllers/
|   |   |-- AuthController.php
|   |   |-- DataController.php
|   |   |-- EntityController.php
|   |   |-- InvoiceController.php
|   |   |-- PartnerController.php
|   |   |-- AccountController.php
|   |   |-- CheckController.php
|   |-- models/
|       |-- BaseModel.php
|       |-- (Customer.php, Supplier.php, Account.php, etc.)
```

  * **`api.php`**: فایل سازگاری که تمام درخواست‌ها را به روتر اصلی هدایت می‌کند.
  * **`api/index.php` (روتر)**: قلب بک‌اند که درخواست‌ها را به `Controller` مناسب مسیردهی می‌کند.
  * **پوشه `api/controllers/`**:
      * **`EntityController.php`**: کنترلر عمومی برای موجودیت‌های ساده.
      * **`InvoiceController.php`, `PartnerController.php`, `AccountController.php`, `CheckController.php`**: کنترلرهای اختصاصی برای مدیریت منطق پیچیده‌تر هر بخش.
  * **پوشه `api/models/`**:
      * **`BaseModel.php`**: یک کلاس پایه که منطق مشترک دیتابیس (صفحه‌بندی، حذف با مدیریت خطا) را در خود دارد.
      * **سایر فایل‌های مدل**: هر فایل مسئولیت تعامل با جدول مربوط به خود را دارد. مدل‌های مهم مانند `Invoice.php`، `Expense.php` و `Partner.php` منطق مربوط به بروزرسانی موجودی حساب‌ها (`Account->updateBalance`) را نیز در خود دارند.

-----

## ۵. جریان یک درخواست (مثال: وصول یک چک)

1.  **کاربر** روی دکمه "وصول چک" در جدول مدیریت چک‌ها کلیک می‌کند.
2.  **`app.js`**: رویداد کلیک را شناسایی کرده، مودال وصول چک (`cashCheckModal`) را باز می‌کند و لیست حساب‌ها را در آن قرار می‌دهد.
3.  **کاربر** حساب مقصد را انتخاب و دکمه "ثبت وصول" را کلیک می‌کند.
4.  **`app.js`**: اطلاعات فرم (شناسه چک و شناسه حساب) را جمع‌آوری می‌کند.
5.  **`api.js`**: یک درخواست `POST` به `api.php?action=cash_check` ارسال می‌کند.
6.  **`api/index.php` (روتر)**: درخواست را به متد `cash` در `CheckController` مسیردهی می‌کند.
7.  **`api/controllers/CheckController.php`**: متد `cashCheck` را از مدل `Check.php` فراخوانی می‌کند.
8.  **`api/models/Check.php`**:
      * وضعیت چک را در جدول `checks` به `cashed` تغییر می‌دهد.
      * شناسه حساب مقصد را در ستون `cashed_in_account_id` ثبت می‌کند.
      * متد `updateBalance` را از مدل `Account.php` فراخوانی کرده و مبلغ چک را به موجودی حساب مقصد اضافه می‌کند.
      * تمام این عملیات در یک **تراکنش (Transaction)** دیتابیس انجام می‌شود تا از صحت داده‌ها اطمینان حاصل شود.
9.  **بازگشت پاسخ**: نتیجه موفقیت‌آمیز به صورت JSON به کلاینت بازگردانده می‌شود.
10. **`app.js`**: مودال را بسته و درخواست بارگذاری مجدد لیست چک‌ها و لیست حساب‌ها را ارسال می‌کند تا کاربر تغییرات را مشاهده کند.




# مستندات فنی جامع: سیستم حسابداری بازرگانی فرش

**آخرین بروزرسانی:** 2025/08/30

## 1. نمای کلی و اهداف پروژه

این پروژه یک سیستم حسابداری تحت وب برای مدیریت عملیات بازرگانی فرش است. هدف اصلی آن، فراهم کردن ابزاری یکپارچه برای مدیریت فاکتورهای خرید و فروش، انبار و محصولات، هزینه‌ها، چک‌ها، شرکا و گزارش‌گیری‌های مالی است. برنامه با رویکرد مدرن (Single Page Application-like) طراحی شده که در آن بارگذاری مجدد صفحه به حداقل رسیده و تعاملات کاربر از طریق AJAX انجام می‌شود.

-----

## 2. پشته فنی (Tech Stack)

* **سمت سرور (Backend):**
    * **زبان:** PHP (سازگار با نسخه‌های 7.x و بالاتر)
    * **دیتابیس:** MySQL / MariaDB
    * **محیط سرور:** نیازمند وب سرور Apache یا Nginx با پشتیبانی از PHP.
    * **نکته سازگاری:** تمام کدهای دیتابیس با استفاده از روش سازگار `bind_result` به جای `get_result` نوشته شده‌اند تا از بروز خطا در سرورهای فاقد درایور `mysqlnd` جلوگیری شود.

* **سمت کاربر (Frontend):**
    * **زبان‌ها:** HTML5, CSS3, JavaScript (ES6)
    * **کتابخانه‌ها:**
        * **jQuery:** برای دستکاری DOM و مدیریت رویدادها.
        * **Bootstrap 5:** برای طراحی رابط کاربری واکنش‌گرا (Responsive).
        * **Select2:** برای ایجاد dropdownهای قابل جستجو.
        * **Persian Datepicker & Persian Date:** برای انتخاب و تبدیل تاریخ شمسی.
        * **DataTables.js:** برای افزودن قابلیت‌های پیشرفته (جستجو، صفحه‌بندی، مرتب‌سازی) به جداول.
        * **Chart.js:** برای رندر کردن نمودارها در داشبورد.

-----

## 3. معماری برنامه

برنامه از یک معماری دو لایه کلاینت-سرور پیروی می‌کند:

* **کلاینت (Frontend):** یک صفحه اصلی (`index.html`) که تمام رابط کاربری را در خود جای داده است. ناوبری بین بخش‌های مختلف از طریق تب‌های بوت‌استرپ انجام می‌شود و تمام درخواست‌های داده از طریق AJAX به بک‌اند ارسال می‌گردد. کدهای جاوا اسکریپت به صورت ماژولار سازماندهی شده‌اند تا مدیریت و توسعه آن‌ها آسان باشد.

* **سرور (Backend):** یک API تقریباً RESTful که از طریق فایل `api.php` در دسترس است. این API از الگوی **Router-Controller-Model** برای مدیریت درخواست‌ها استفاده می‌کند:

    1.  **Router (`api/index.php`):** نقطه ورود تمام درخواست‌هاست. این فایل بر اساس پارامتر `action`، درخواست را به کنترلر و متد مناسب هدایت می‌کند.
    2.  **Controller (`api/controllers/`):** لایه منطقی برنامه است. کنترلرها درخواست را دریافت کرده، داده‌های ورودی را اعتبارسنجی می‌کنند و متدهای مناسب از مدل‌ها را فراخوانی می‌نمایند.
    3.  **Model (`api/models/`):** لایه دسترسی به داده‌هاست. تمام کوئری‌های SQL و تعاملات با دیتابیس در این لایه انجام می‌شود.

-----

## 4. ساختار دیتابیس

ساختار دیتابیس برای پشتیبانی از عملیات مختلف حسابداری طراحی شده است. نکات کلیدی:

* **نوع داده تاریخ:** تمام ستون‌های مربوط به تاریخ (مانند `date` و `dueDate`) از نوع استاندارد **`DATE`** دیتابیس هستند. این کار مرتب‌سازی، فیلترینگ و محاسبات مبتنی بر تاریخ را دقیق و کارآمد می‌کند. داده‌ها به صورت میلادی (`YYYY-MM-DD`) ذخیره می‌شوند.
* **یکپارچگی داده:** از کلیدهای خارجی (Foreign Keys) با قید `ON DELETE RESTRICT` برای جلوگیری از حذف داده‌های مرتبط (مانند حذف مشتری که دارای فاکتور است) و `ON DELETE CASCADE` برای حذف خودکار آیتم‌های وابسته (مانند آیتم‌های یک فاکتور حذف شده) استفاده می‌شود.
* **تراکنش‌ها:** تمام عملیات‌های چندمرحله‌ای و حساس (مانند ثبت فاکتور به همراه پرداخت‌ها و بروزرسانی موجودی) داخل تراکنش‌های دیتابیس (`Transaction`) انجام می‌شوند تا از یکپارچگی کامل داده‌ها اطمینان حاصل شود.

-----

## 5. منطق‌های کلیدی و جریان‌های کاری

### الف) مدیریت تاریخ

* **ورودی کاربر:** کاربر تمام تاریخ‌ها را از طریق یک کامپوننت تقویم شمسی (`Persian Datepicker`) انتخاب می‌کند.
* **سمت کاربر:** قبل از ارسال هرگونه تاریخ به سرور، تابع جاوا اسکریپت `UI.toGregorian` آن را از فرمت شمسی (`YYYY/MM/DD`) به فرمت استاندارد میلادی (`YYYY-MM-DD`) تبدیل می‌کند.
* **سمت سرور:** تاریخ میلادی را دریافت و در ستون `DATE` دیتابیس ذخیره می‌کند.
* **نمایش به کاربر:** هنگام دریافت داده از سرور، تابع جاوا اسکریپت `UI.gregorianToPersian` تاریخ میلادی را دوباره به فرمت خوانای شمسی برای نمایش در جداول و فرم‌ها تبدیل می‌کند.

### ب) همگام‌سازی و بروزرسانی دیتابیس

* فایل `setup.php` به عنوان یک اسکریپت **نصب و بروزرسانی هوشمند** عمل می‌کند.
* **در اولین اجرا:** دیتابیس و تمام جداول را از ابتدا ایجاد کرده و کاربر ادمین پیش‌فرض را ثبت می‌کند.
* **در اجراهای بعدی:** اسکریپت ساختار دیتابیس موجود را با ساختار تعریف‌شده در کد مقایسه می‌کند و به صورت خودکار موارد زیر را انجام می‌دهد:
    * جداول فراموش‌شده را ایجاد می‌کند.
    * ستون‌های جدیدی که به مدل‌ها اضافه شده‌اند را به جداول موجود اضافه می‌کند.
    * نوع داده ستون‌های کلیدی را در صورت مغایرت، اصلاح می‌کند.
    * این قابلیت به مدیر سیستم اجازه می‌دهد تا با اجرای مجدد این فایل، دیتابیس را با آخرین نسخه برنامه همگام‌سازی کند.
* **امنیت:** پس از اتمام کار، باید فایل `setup.php` برای جلوگیری از دسترسی‌های غیرمجاز **فوراً حذف شود**.

### ج) امنیت خروجی (XSS Protection)

* برای جلوگیری از حملات Cross-Site Scripting (XSS)، تمام داده‌های متنی که از سرور به کلاینت ارسال می‌شوند، به صورت خودکار توسط تابع `sanitize_output` در فایل `api/core/helpers.php` پردازش می‌شوند. این تابع کاراکترهای HTML خاص را به معادل‌های امن تبدیل می‌کند و تضمین می‌کند که کدهای مخرب تزریق‌شده توسط کاربران در مرورگر دیگران اجرا نشوند.

بسیار خب، متوجه شدم. مستندات فنی را با جزئیات کامل و **دقیقاً مطابق با آخرین نسخه کد که شامل داشبورد جدید و بهبودهای بخش تراکنشات است**، بروزرسانی می‌کنم و بخش مربوط به پیشنهاد ماژولار کردن `index.html` را حذف خواهم کرد.

در ادامه، فایل `DOCUMENTATION.md` بروزرسانی‌شده به صورت کامل ارائه می‌شود.

-----

### فایل `DOCUMENTATION.md` (بروزرسانی نهایی)

```markdown
# مستندات فنی جامع: سیستم حسابداری بازرگانی فرش

**آخرین بروزرسانی:** 2025/09/03

## ۱. نمای کلی و اهداف پروژه

این پروژه یک سیستم حسابداری تحت وب برای مدیریت عملیات بازرگانی فرش است. هدف اصلی آن، فراهم کردن ابزاری یکپارچه برای مدیریت فاکتورهای خرید و فروش، انبار و محصولات، هزینه‌ها، چک‌ها، شرکا و گزارش‌گیری‌های مالی است. برنامه با رویکرد مدرن (Single Page Application-like) طراحی شده که در آن بارگذاری مجدد صفحه به حداقل رسیده و تعاملات کاربر از طریق AJAX انجام می‌شود. منطق ثبت چک و تراکنشات در این سیستم یکپارچه شده تا تمامی رویدادهای مالی به درستی در حساب اشخاص ثبت و نگهداری شوند.

-----

## ۲. پشته فنی (Tech Stack)

* **سمت سرور (Backend):**
    * **زبان:** PHP (سازگار با نسخه‌های 7.x و بالاتر)
    * **دیتابیس:** MySQL / MariaDB
    * **محیط سرور:** نیازمند وب سرور Apache یا Nginx با پشتیبانی از PHP.
    * **نکته سازگاری:** تمام کدهای دیتابیس با استفاده از یک تابع کمکی مرکزی که از روش سازگار `bind_result` استفاده می‌کند، نوشته شده‌اند تا از بروز خطا در سرورهای فاقد درایور `mysqlnd` جلوگیری شود.

* **سمت کاربر (Frontend):**
    * **زبان‌ها:** HTML5, CSS3, JavaScript (ES6)
    * **کتابخانه‌ها:**
        * **jQuery:** برای دستکاری DOM و مدیریت رویدادها.
        * **Bootstrap 5:** برای طراحی رابط کاربری واکنش‌گرا (Responsive).
        * **Select2:** برای ایجاد dropdownهای قابل جستجو.
        * **Persian Datepicker & Persian Date:** برای انتخاب و تبدیل تاریخ شمسی.
        * **DataTables.js:** برای افزودن قابلیت‌های پیشرفته (جستجو، صفحه‌بندی، مرتب‌سازی) به جداول.
        * **Chart.js:** برای رندر کردن نمودارها در داشبورد.

-----

## ۳. معماری برنامه

برنامه از یک معماری دو لایه کلاینت-سرور پیروی می‌کند:

* **کلاینت (Frontend):** یک صفحه اصلی (`index.html`) که تمام رابط کاربری را در خود جای داده است. ناوبری بین بخش‌های مختلف از طریق تب‌های بوت‌استرپ انجام می‌شود و تمام درخواست‌های داده از طریق AJAX به بک‌اند ارسال می‌گردد. کدهای جاوا اسکریپت به صورت ماژولار سازماندهی شده‌اند تا مدیریت و توسعه آن‌ها آسان باشد.

* **سرور (Backend):** یک API تقریباً RESTful که از طریق فایل `api/index.php` در دسترس است. این API از الگوی **Router-Controller-Model** برای مدیریت درخواست‌ها استفاده می‌کند:

    1.  **Router (`api/index.php`):** نقطه ورود تمام درخواست‌هاست. این فایل بر اساس پارامتر `action`، درخواست را به کنترلر و متد مناسب هدایت می‌کند.
    2.  **Controller (`api/controllers/`):** لایه منطقی برنامه است. کنترلرها درخواست را دریافت کرده، داده‌های ورودی را اعتبارسنجی می‌کنند و متدهای مناسب از مدل‌ها را فراخوانی می‌نمایند.
    3.  **Model (`api/models/`):** لایه دسترسی به داده‌هاست. تمام کوئری‌های SQL و تعاملات با دیتابیس در این لایه انجام می‌شود.

-----

## ۴. ساختار فایل‌ها و تشریح نقش هر فایل

### الف) ساختار فرانت‌اند

```

/ (root)
|-- index.html
|-- style.css
|-- js/
|   |-- app.js
|   |-- api.js
|   |-- auth.js
|   |-- config.js
|   |-- dashboard.js
|   |-- entity-manager.js
|   |-- invoice-manager.js
|   |-- partner-manager.js
|   |-- account-manager.js
|   |-- check-manager.js  (جدید)
|   |-- transaction-manager.js
|   |-- reports.js
|   |-- ui.js

```

* **`js/app.js`**: **ارکستریتور اصلی برنامه**. این فایل تمام ماژول‌های دیگر از جمله `CheckManager` جدید را مقداردهی اولیه کرده، `appCache` (شامل لیست مشتریان، حساب‌ها و...) را مدیریت می‌کند و رویدادهای اصلی مانند کلیک روی تب‌ها را کنترل می‌نماید.
* **`js/dashboard.js`**: مسئول بارگذاری و نمایش داده‌های جدید و کاربردی در **داشبورد بازطراحی‌شده** است. این ماژول کارت "فروش ۳۰ روز گذشته"، نمودار میله‌ای تامین‌کنندگان بدهکار، لیست مشتریان تسویه نشده و جداول چک‌های سررسید نزدیک را رندر می‌کند.
* **`js/transaction-manager.js`**: ماژول مدیریت "مرکز تراکنشات". قابلیت‌های جدیدی مانند **دکمه‌های فیلتر** (همه، پرداخت/دریافت، هزینه‌ها)، فعال‌سازی **مرتب‌سازی ستون‌ها**، استفاده از **Select2** برای انتخاب اشخاص و امکان **خرج چک دریافتی** در این ماژول پیاده‌سازی شده است.
* **`js/check-manager.js`**: **(فایل جدید)** ماژول اختصاصی برای مدیریت کامل تب "مدیریت چک‌ها". این ماژول مسئول نمایش جدول چک‌ها، و مهم‌تر از همه، مدیریت مودال "ثبت چک جدید" است. این مودال با تبدیل عمل ثبت چک به یک **تراکنش مالی کامل** (از طریق API `save_payment`)، صحت محاسبات حسابداری را تضمین می‌کند.

### ب) ساختار بک‌اند

```

/ (root)
|-- api/
|   |-- index.php
|   |-- core/
|   |   |-- helpers.php
|   |-- controllers/
|   |   |-- DataController.php
|   |   |-- CheckController.php
|   |   |-- (سایر کنترلرها...)
|   |-- models/
|       |-- Check.php
|       |-- Payment.php
|       |-- (سایر مدل‌ها...)

```

* **`api/core/helpers.php`**: این فایل اکنون شامل تابع مرکزی `db_stmt_to_assoc_array()` است که در **تمام** مدل‌ها و کنترلرها برای دریافت نتایج دیتابیس به شیوه‌ای سازگار و استاندارد استفاده می‌شود. این تغییر باعث رفع کامل خطاهای `Commands out of sync` شده است.
* **`api/controllers/DataController.php`**: منطق متد `getDashboardData` در این کنترلر به طور کامل بازنویسی شده تا داده‌های جدید و کاربردی مورد نیاز داشبورد (فروش ماه اخیر، تامین‌کنندگان بدهکار، مشتریان تسویه نشده و چک‌ها) را فراهم کند.
* **`api/controllers/CheckController.php`**: مسئولیت این کنترلر تغییر کرده و اکنون فقط شامل منطق **عملیات روی چک‌های موجود** (وصول، پاس کردن، و `delete` امن) است. منطق ایجاد چک به `PaymentController` منتقل شده است.
* **`api/models/Check.php`**: مدل چک اکنون دارای منطق `delete` بازنویسی‌شده است که به صورت امن و در قالب یک تراکنش دیتابیس، **تراکنش پرداخت (`payment`)** مرتبط با چک را نیز حذف می‌کند تا از بروز مغایرت در حساب‌ها جلوگیری شود.
* **`api/models/Payment.php`**: این مدل اکنون به عنوان مرکز اصلی ثبت تمام تراکنش‌های مالی (نقد، چک مستقل، چک فاکتور، خرج چک) عمل می‌کند. منطق آن برای مدیریت صحیح `endorse_check` (خرج چک) بروزرسانی شده است.

-----

## 5. منطق‌های کلیدی و جریان‌های کاری جدید

### الف) جریان کاری: ثبت چک مستقل (علی الحساب)

منطق ایجاد چک به طور کامل بازطراحی شده تا با اصول حسابداری تطابق داشته باشد. هر چک جدید به عنوان یک تراکنش مالی ثبت می‌شود.

1.  **کاربر** روی دکمه "ثبت چک جدید" در تب "مدیریت چک‌ها" کلیک می‌کند.
2.  **`check-manager.js`**: مودال `checkModal` را باز می‌کند که در آن فیلدهایی برای انتخاب **شخص طرف حساب**، **نوع تراکنش** (دریافت/پرداخت) و مشخصات چک وجود دارد.
3.  **کاربر** اطلاعات را تکمیل و فرم را ثبت می‌کند.
4.  **`check-manager.js`**: داده‌ها را در قالب یک آبجکت `payment` جمع‌آوری کرده و به اکشن `save_payment` در بک‌اند ارسال می‌کند.
5.  **`api/index.php`**: درخواست را به `PaymentController` هدایت می‌کند.
6.  **`api/models/Payment.php`**: متد `save` اجرا می‌شود. این متد:
    * یک رکورد در جدول `payments` با `invoiceId = NULL` (به معنی علی‌الحساب) ثبت می‌کند.
    * یک رکورد جدید در جدول `checks` با مشخصات وارد شده ایجاد می‌کند.
    * شناسه چک جدید را در ستون `checkId` رکورد `payments` ذخیره می‌کند.
7.  **نتیجه:** با این فرآیند، نه تنها چک در سیستم ثبت می‌شود، بلکه **اثر مالی آن** (بدهکار یا بستانکار شدن شخص) نیز به درستی در حساب علی‌الحساب او منظور می‌گردد، زیرا گزارشات از جدول `payments` برای محاسبه مانده حساب استفاده می‌کنند.

### ب) جریان کاری: خرج چک دریافتی (در تراکنش علی‌الحساب)

1.  **کاربر** از طریق مودال "ثبت تراکنش جدید"، یک تراکنش از نوع "پرداخت وجه" را انتخاب می‌کند.
2.  **`transaction-manager.js`**: کاربر در فیلد "شیوه پرداخت"، گزینه "خرج چک دریافتی" را انتخاب می‌کند.
3.  یک لیست کشویی از چک‌های دریافتی که وضعیت آن‌ها "نزد ما" (`in_hand`) است، از طریق `appCache` نمایش داده می‌شود.
4.  کاربر چک مورد نظر را انتخاب می‌کند. مبلغ تراکنش به صورت خودکار با مبلغ چک پر می‌شود.
5.  پس از ثبت، یک درخواست به اکشن `save_payment` با `type = 'endorse_check'` و `checkId` چک انتخاب شده ارسال می‌شود.
6.  **`api/models/Payment.php`**: علاوه بر ثبت تراکنش پرداخت، وضعیت چک مورد نظر را در جدول `checks` از `in_hand` به `endorsed` (واگذار شده) تغییر می‌دهد.
```


--------------------------------------------------------------------------------------------------------------------------------------

باشه، طبق درخواست شما، یک مستندات فنی بسیار جامع و کامل از وضعیت فعلی برنامه، با تمام جزئیات مربوط به ساختار فایل‌ها، نقش هر فایل، و تشریح متدها و جریان‌های کاری کلیدی تهیه کرده‌ام. این فایل به گونه‌ای طراحی شده که به عنوان یک مرجع کامل برای درک و توسعه آینده برنامه عمل کند.

-----

# مستندات فنی جامع: سیستم حسابداری بازرگانی فرش

**آخرین بروزرسانی:** 2025/09/07

## 1. نمای کلی و اهداف پروژه

این پروژه یک سیستم حسابداری تحت وب برای مدیریت عملیات بازرگانی فرش است. هدف اصلی آن، فراهم کردن ابزاری یکپارچه برای مدیریت فاکتورهای خرید و فروش، انبار و محصولات، هزینه‌ها، چک‌ها، شرکا و گزارش‌گیری‌های مالی است. برنامه با رویکرد مدرن (Single Page Application-like) طراحی شده که در آن بارگذاری مجدد صفحه به حداقل رسیده و تعاملات کاربر از طریق AJAX انجام می‌شود.

-----

## 2. پشته فنی (Tech Stack)

* **سمت سرور (Backend):**
    * **زبان:** PHP (سازگار با نسخه‌های 7.x و بالاتر)
    * **دیتابیس:** MySQL / MariaDB
    * **محیط سرور:** نیازمند وب سرور Apache یا Nginx با پشتیبانی از PHP.
    * **نکته سازگاری:** تمام کدهای دیتابیس با استفاده از یک تابع کمکی مرکزی (`db_stmt_to_assoc_array`) که از روش سازگار `bind_result` استفاده می‌کند، نوشته شده‌اند تا از بروز خطا در سرورهای فاقد درایور `mysqlnd` جلوگیری شود.

* **سمت کاربر (Frontend):**
    * **زبان‌ها:** HTML5, CSS3, JavaScript (ES6)
    * **کتابخانه‌ها:**
        * **jQuery:** برای دستکاری DOM و مدیریت رویدادها.
        * **Bootstrap 5:** برای طراحی رابط کاربری واکنش‌گرا (Responsive).
        * **Select2:** برای ایجاد dropdownهای قابل جستجو.
        * **Persian Datepicker & Persian Date:** برای انتخاب و تبدیل تاریخ شمسی.
        * **DataTables.js:** برای افزودن قابلیت‌های پیشرفته به جداول.
        * **Chart.js:** برای رندر کردن نمودارها در داشبورد.
        * **Toastr.js:** برای نمایش اعلان‌های غیرتهاجمی (Non-intrusive notifications).

-----

## 3. معماری برنامه

برنامه از یک معماری دو لایه کلاینت-سرور پیروی می‌کند:

* **کلاینت (Frontend):** یک فایل `index.php` به عنوان پوسته اصلی عمل می‌کند که تمام اجزای رابط کاربری را از پوشه `templates` فراخوانی می‌کند. این ساختار ماژولار، مدیریت UI را ساده می‌کند. کدهای جاوا اسکریپت نیز به صورت ماژولار (مانند `invoice-manager.js`, `check-manager.js`) سازماندهی شده‌اند و توسط `app.js` مدیریت و مقداردهی اولیه می‌شوند.

* **سرور (Backend):** یک API تقریباً RESTful که از طریق فایل `api/index.php` در دسترس است. این API از الگوی **Router-Controller-Model** برای مدیریت درخواست‌ها استفاده می‌کند:

    1.  **Router (`api/index.php`):** نقطه ورود تمام درخواست‌هاست. این فایل بر اساس پارامتر `action`، درخواست را به کنترلر و متد مناسب هدایت می‌کند. همچنین مسئولیت **تأیید توکن CSRF** برای تمام درخواست‌های POST را بر عهده دارد.
    2.  **Controller (`api/controllers/`):** لایه منطقی برنامه است. کنترلرها درخواست را دریافت کرده، داده‌های ورودی را اعتبارسنجی می‌کنند و متدهای مناسب از مدل‌ها را فراخوانی می‌نمایند.
    3.  **Model (`api/models/`):** لایه دسترسی به داده‌هاست. تمام کوئری‌های SQL و تعاملات با دیتابیس در این لایه انجام می‌شود.

-----

## 4. ساختار فایل‌ها و تشریح نقش هر فایل

### الف) ساختار کلی ریشه پروژه

* `index.php`: فایل اصلی و پوسته برنامه. مسئول بارگذاری تمام اجزای UI از پوشه `templates` و همچنین تمام فایل‌های CSS و JS.
* `api.php`: یک پراکسی ساده که تمام درخواست‌های API را به `api/index.php` هدایت می‌کند.
* `setup.php`: اسکریپت نصب و بروزرسانی هوشمند دیتابیس. ساختار جداول را با کد مقایسه کرده و تغییرات لازم (شامل افزودن ایندکس‌ها) را اعمال می‌کند. **(باید پس از نصب حذف شود)**.
* `templates/`: پوشه‌ای حاوی فایل‌های PHP که هر کدام یک بخش از رابط کاربری را تعریف می‌کنند.
* `js/`: شامل تمام کدهای جاوا اسکریپت سمت کلاینت.
* `api/`: شامل تمام کدهای سمت سرور برنامه.

### ب) تشریح فایل‌های `js/` (سمت کاربر)

* `app.js` (هماهنگ‌کننده اصلی): مسئول راه‌اندازی اولیه، مدیریت کش (`appCache`)، اتصال رویدادهای عمومی (کلیک روی تب‌ها، دکمه‌های صفحه‌بندی) و مدیریت **داشبورد تعاملی** و **سیستم اعلان**.
* `api.js`: ماژول مرکزی برای ارسال تمام درخواست‌های AJAX. این فایل اکنون به صورت خودکار **توکن CSRF** را در هدر تمام درخواست‌ها قرار می‌دهد.
* `ui.js`: شامل توابع کمکی رابط کاربری. تمام `alert()` ها با توابع `UI.showSuccess()` و `UI.showError()` که از **Toastr.js** استفاده می‌کنند، جایگزین شده‌اند.
* `invoice-manager.js` (ماژول پیچیده): مدیریت کامل فاکتورها. بدون تغییر عمده در منطق اصلی.
* `check-manager.js`: مدیریت تب "مدیریت چک‌ها".
* `transaction-manager.js`: مدیریت تب "مرکز تراکنشات".
* `reports.js`: مسئول تولید گزارشات مالی. قابلیت **خروجی CSV** در این ماژول پیاده‌سازی شده است.
* `dashboard.js`: منطق بارگذاری و نمایش داده‌ها در داشبورد. ردیف‌های جداول اکنون دارای `data-*` attribute برای فعال‌سازی تعامل هستند.

### ج) تشریح فایل‌های `api/` (سمت سرور)

* `api/index.php` (روتر اصلی): قبل از اجرای هر اکشن POST، اعتبار توکن CSRF ارسال‌شده در هدر را بررسی می‌کند.
* `api/core/helpers.php`: شامل توابع جدید `generate_csrf_token()` و `verify_csrf_token()`.
* `api/controllers/AuthController.php`: در متد `login`، پس از ورود موفق، یک توکن CSRF جدید تولید کرده و برای کلاینت ارسال می‌کند.
* `api/controllers/DataController.php`: شامل متد جدید `getNotifications()` برای سیستم اعلان.
* `api/controllers/ReportController.php`: شامل متد جدید `exportReport()` برای مدیریت درخواست‌های خروجی CSV.
* `api/models/DashboardModel.php`: شامل متد جدید `getNotificationsData()` که تعداد چک‌های با سررسید نزدیک را شمارش می‌کند.
* `api/models/ReportModel.php`: شامل متد جدید `getReportForExport()` که داده‌های گزارش را برای تبدیل به فرمت CSV آماده می‌کند.
* `api/models/Check.php`: متد `delete` بازنویسی شده تا تراکنش مالی مرتبط با چک را نیز به صورت امن حذف کند.

-----

## 5. جریان‌های کاری کلیدی

### الف) جریان امنیتی: جلوگیری از حمله CSRF

1.  **ورود کاربر:** کاربر با موفقیت وارد سیستم می‌شود. `AuthController` یک توکن امن (`csrf_token`) در `$_SESSION` ایجاد کرده و آن را به همراه پیام موفقیت به کلاینت ارسال می‌کند.
2.  **ذخیره در کلاینت:** `api.js` توکن دریافت شده را در تگ `<meta name="csrf-token">` صفحه ذخیره می‌کند.
3.  **ارسال درخواست مخرب (مثلاً حذف فاکتور):** کاربر فرمی را (مثلاً در یک مودال) برای حذف فاکتور ثبت می‌کند.
4.  **افزودن هدر:** `api.js` قبل از ارسال درخواست `POST`، توکن را از تگ `meta` خوانده و در هدر `X-CSRF-TOKEN` قرار می‌دهد.
5.  **تأیید در سرور:** `api/index.php` (روتر) قبل از فراخوانی `InvoiceController`، بررسی می‌کند که آیا درخواست از نوع `POST` است یا خیر. اگر بود، تابع `verify_csrf_token()` را اجرا می‌کند. این تابع، توکن موجود در هدر را با توکن ذخیره‌شده در `$_SESSION` مقایسه می‌کند.
6.  **نتیجه:** اگر توکن‌ها مطابقت داشته باشند، درخواست پردازش می‌شود. در غیر این صورت، اسکریپت با خطای 403 (Forbidden) متوقف شده و از اجرای عملیات مخرب جلوگیری می‌شود.


# مستندات فنی جامع: سیستم حسابداری بازرگانی فرش

**آخرین بروزرسانی:** ۲۰۲۵/۰۹/۱۵

## ۱. نمای کلی و اهداف پروژه

این پروژه یک سیستم حسابداری تحت وب برای مدیریت عملیات بازرگانی فرش است. هدف اصلی آن، فراهم کردن ابزاری یکپارچه برای مدیریت فاکتورهای خرید و فروش، انبار و محصولات، هزینه‌ها، چک‌ها، شرکا و گزارش‌گیری‌های مالی است. برنامه با رویکرد مدرن (Single Page Application-like) طراحی شده که در آن بارگذاری مجدد صفحه به حداقل رسیده و تعاملات کاربر از طریق AJAX انجام می‌شود.

-----

## ۲. پشته فنی (Tech Stack)

* **سمت سرور (Backend):**
    * **زبان:** PHP (سازگار با نسخه‌های 7.x و بالاتر)
    * **دیتابیس:** MySQL / MariaDB
    * **محیط سرور:** نیازمند وب سرور Apache یا Nginx با پشتیبانی از PHP.
    * **نکته سازگاری:** تمام کدهای دیتابیس با استفاده از یک تابع کمکی مرکزی (`db_stmt_to_assoc_array`) که از روش سازگار `bind_result` استفاده می‌کند، نوشته شده‌اند تا از بروز خطا در سرورهای فاقد درایور `mysqlnd` جلوگیری شود.

* **سمت کاربر (Frontend):**
    * **زبان‌ها:** HTML5, CSS3, JavaScript (ES6)
    * **کتابخانه‌ها:**
        * **jQuery:** برای دستکاری DOM و مدیریت رویدادها.
        * **Bootstrap 5:** برای طراحی رابط کاربری واکنش‌گرا (Responsive).
        * **Select2:** برای ایجاد dropdownهای قابل جستجو.
        * **Persian Datepicker & Persian Date:** برای انتخاب و تبدیل تاریخ شمسی.
        * **DataTables.js:** برای افزودن قابلیت‌های پیشرفته به جداول.
        * **Chart.js:** برای رندر کردن نمودارها در داشبورد.
        * **Toastr.js:** برای نمایش اعلان‌های غیرتهاجمی (Non-intrusive notifications).

-----

## ۳. معماری برنامه

برنامه از یک معماری دو لایه کلاینت-سرور پیروی می‌کند:

* **کلاینت (Frontend):** یک فایل `index.php` به عنوان پوسته اصلی عمل می‌کند که تمام اجزای رابط کاربری را از پوشه `templates` فراخوانی می‌کند. این ساختار ماژولار، مدیریت UI را ساده می‌کند. کدهای جاوا اسکریپت نیز به صورت ماژولار (مانند `invoice-manager.js`, `check-manager.js`) سازماندهی شده‌اند و توسط `app.js` مدیریت و مقداردهی اولیه می‌شوند.

* **سرور (Backend):** یک API تقریباً RESTful که از طریق فایل `api/index.php` در دسترس است. این API از الگوی **Router-Controller-Model** برای مدیریت درخواست‌ها استفاده می‌کند:

    1.  **Router (`api/index.php`):** نقطه ورود تمام درخواست‌هاست. این فایل بر اساس پارامتر `action`، درخواست را به کنترلر و متد مناسب هدایت می‌کند. همچنین مسئولیت **تأیید توکن CSRF** برای تمام درخواست‌های `POST` را بر عهده دارد.
    2.  **Controller (`api/controllers/`):** لایه منطقی برنامه است. کنترلرها درخواست را دریافت کرده، داده‌های ورودی را اعتبارسنجی می‌کنند و متدهای مناسب از مدل‌ها را فراخوانی می‌نمایند.
    3.  **Model (`api/models/`):** لایه دسترسی به داده‌هاست. تمام کوئری‌های SQL و تعاملات با دیتابیس در این لایه انجام می‌شود.

-----

## ۴. ساختار فایل‌ها و تشریح نقش هر فایل

### الف) ساختار کلی ریشه پروژه

* `index.php`: فایل اصلی و پوسته برنامه. مسئول بارگذاری تمام اجزای UI از پوشه `templates` و همچنین تمام فایل‌های CSS و JS.
* `api.php`: یک پراکسی ساده که تمام درخواست‌های API را به `api/index.php` هدایت می‌کند.
* `templates/`: پوشه‌ای حاوی فایل‌های PHP که هر کدام یک بخش از رابط کاربری را تعریف می‌کنند (مانند `section_sales.php`).
* `js/`: شامل تمام کدهای جاوا اسکریپت سمت کلاینت.
* `api/`: شامل تمام کدهای سمت سرور برنامه.

### ب) تشریح فایل‌های `js/` (سمت کاربر)

* `app.js` (هماهنگ‌کننده اصلی): مسئول راه‌اندازی اولیه، مدیریت کش (`appCache`)، و اتصال رویدادهای عمومی (کلیک روی تب‌ها، دکمه‌های صفحه‌بندی).
* `api.js`: ماژول مرکزی برای ارسال تمام درخواست‌های AJAX. این فایل به صورت خودکار **توکن CSRF** را در هدر تمام درخواست‌ها قرار می‌دهد.
* `ui.js`: شامل توابع کمکی رابط کاربری. تمام `alert()` ها با توابع `UI.showSuccess()` و `UI.showError()` که از **Toastr.js** استفاده می‌کنند، جایگزین شده‌اند.
* `invoice-manager.js`: مدیریت کامل فاکتورها.
* `check-manager.js`: مدیریت تب "مدیریت چک‌ها".
* `transaction-manager.js`: مدیریت تب "مرکز تراکنشات" و مودال جامع ثبت پرداخت/دریافت/هزینه.
* `reports.js`: مسئول تولید گزارشات مالی، شامل قابلیت **خروجی CSV**.
* `dashboard.js`: منطق بارگذاری و نمایش داده‌ها در داشبورد.
* `settings-manager.js`: مدیریت منطق تب تنظیمات.
* `entity-manager.js`: یک کارخانه (factory) برای ایجاد مدیرهای ساده (مشتریان، تامین‌کنندگان، و غیره).

### ج) تشریح فایل‌های `api/` (سمت سرور)

* `api/index.php` (روتر اصلی): قبل از اجرای هر اکشن `POST`، اعتبار توکن CSRF ارسال‌شده در هدر را بررسی می‌کند.
* `api/core/helpers.php`: شامل توابع کمکی مانند `send_json`, `log_activity` و توابع امنیتی `generate_csrf_token()` و `verify_csrf_token()`.
* `api/controllers/AuthController.php`: در متد `login`، پس از ورود موفق، یک توکن CSRF جدید تولید کرده و برای کلاینت ارسال می‌کند.
* `api/controllers/ReportController.php`: شامل متد `exportReport()` برای مدیریت درخواست‌های خروجی CSV.
* `api/models/BaseModel.php`: یک کلاس پایه که منطق مشترک دیتابیس (صفحه‌بندی، حذف با مدیریت خطا) را در خود دارد.
* `api/models/Payment.php`: مدل کلیدی که اکنون مرکزیت تمام تراکنش‌های مالی (نقد، چک، خرج چک) را بر عهده دارد.

-----

## ۵. جریان‌های کاری کلیدی و بهبودهای اعمال‌شده

### الف) جریان امنیتی: جلوگیری از حمله CSRF (پیاده‌سازی شده)

1.  **ورود کاربر:** `AuthController` یک توکن امن (`csrf_token`) در `$_SESSION` ایجاد کرده و آن را به کلاینت ارسال می‌کند.
2.  **ذخیره در کلاینت:** `api.js` توکن دریافت شده را در تگ `<meta name="csrf-token">` صفحه ذخیره می‌کند.
3.  **ارسال درخواست:** برای هر درخواست `POST`، ماژول `api.js` توکن را از تگ `meta` خوانده و در هدر `X-CSRF-TOKEN` قرار می‌دهد.
4.  **تأیید در سرور:** `api/index.php` قبل از اجرای هر اکشن، تابع `verify_csrf_token()` را اجرا می‌کند. این تابع، توکن موجود در هدر را با توکن ذخیره‌شده در `$_SESSION` مقایسه می‌کند.
5.  **نتیجه:** در صورت عدم تطابق، درخواست با خطای 403 رد می‌شود.

### ب) جریان کاری: ثبت متمرکز تراکنشات

* **منطق قدیمی:** ثبت چک و پرداخت‌های نقدی منطق‌های جداگانه‌ای داشتند.
* **منطق جدید:** تمام عملیات‌های مالی (پرداخت/دریافت نقدی، ثبت چک جدید، خرج چک دریافتی) از طریق یک API واحد (`save_payment`) و یک مودال جامع (`transactionModal`) انجام می‌شود. این یکپارچگی تضمین می‌کند که هر رویداد مالی به درستی ثبت شده و در حساب اشخاص و موجودی حساب‌های بانکی منعکس می‌شود.

### ج) بهبود تجربه کاربری (UX)

* **اعتبارسنجی سمت کلاینت:** به تمام فرم‌های اصلی برنامه ویژگی‌های اعتبارسنجی HTML5 (مانند `required`, `minlength`, `type="number"`) اضافه شده است. این کار به کاربر بازخورد فوری داده و از ارسال درخواست‌های ناقص به سرور جلوگیری می‌کند.
* **اعلان‌های Toastr:** تمام پیام‌های `alert()` با اعلان‌های مدرن و غیرتهاجمی Toastr جایگزین شده‌اند که تجربه کاربری بهتری را فراهم می‌کند.

### د) رفع باگ تب تنظیمات

* مشکل اصلی خالی بودن این تب، عدم فراخوانی فایل `templates/section_settings.php` در `index.php` بود. این مشکل با افزودن خط `include` مربوطه حل شد. همچنین باگ جاوا اسکریپت مربوط به رفرش نشدن اطلاعات پس از ذخیره، با یک `location.reload()` مطمئن برطرف گردید.