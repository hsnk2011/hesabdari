# مستندات فنی جامع: سیستم حسابداری بازرگانی فرش

**آخرین بروزرسانی:** ۲۰۲۵/۰۸/۰۳

## ۱. نمای کلی و اهداف پروژه

این پروژه یک سیستم حسابداری تحت وب برای مدیریت عملیات بازرگانی فرش است. هدف اصلی آن، فراهم کردن ابزاری یکپارچه برای مدیریت فاکتورهای خرید و فروش، انبار و محصولات، هزینه‌ها، چک‌ها، شرکا و گزارش‌گیری‌های مالی است. برنامه با رویکرد مدرن (Single Page Application-like) طراحی شده که در آن بارگذاری مجدد صفحه به حداقل رسیده و تعاملات کاربر از طریق AJAX انجام می‌شود.

-----

## ۲. پشته فنی (Tech Stack)

  * **سمت سرور (Backend):**

      * **زبان:** PHP (نسخه سازگار با `call_user_func_array` برای `bind_param`)
      * **دیتابیس:** MySQL / MariaDB
      * **محیط سرور:** نیازمند وب سرور Apache یا Nginx با پشتیبانی از PHP.
      * **نکته مهم:** به دلیل عدم پشتیبانی سرور از درایور `mysqlnd`، تمام کدهای دیتابیس با استفاده از روش سازگارتر `bind_result` به جای `get_result` نوشته شده‌اند تا از بروز خطا جلوگیری شود.

  * **سمت کاربر (Frontend):**

      * **زبان‌ها:** HTML5, CSS3, JavaScript (ES6)
      * **کتابخانه‌ها:**
          * **jQuery:** برای دستکاری DOM و مدیریت رویدادها.
          * **Bootstrap 5:** برای طراحی رابط کاربری واکنش‌گرا (Responsive).
          * **Select2:** برای ایجاد dropdownهای قابل جستجو.
          * **Persian Datepicker:** برای انتخاب تاریخ شمسی.
          * **DataTables.js:** برای افزودن قابلیت‌های پیشرفته (جستجو، صفحه‌بندی، مرتب‌سازی) به جداول.

-----

## ۳. معماری برنامه

برنامه از یک معماری دو لایه کلاینت-سرور پیروی می‌کند:

  * **کلاینت (Frontend):** یک صفحه اصلی (`index.html`) که تمام رابط کاربری را در خود جای داده است. ناوبری بین بخش‌های مختلف از طریق تب‌های بوت‌استرپ انجام می‌شود و تمام درخواست‌های داده از طریق AJAX به بک‌اند ارسال می‌گردد. کدهای جاوا اسکریپت به صورت ماژولار سازماندهی شده‌اند تا مدیریت و توسعه آن‌ها آسان باشد.

  * **سرور (Backend):** یک API تقریباً RESTful که از طریق فایل `api.php` در دسترس است. این API از الگوی **Router-Controller-Model** برای مدیریت درخواست‌ها استفاده می‌کند:

    1.  **Router (`api/index.php`):** نقطه ورود تمام درخواست‌هاست. این فایل بر اساس پارامتر `action`، درخواست را به کنترلر و متد مناسب هدایت می‌کند.
    2.  **Controller (`api/controllers/`):** لایه منطقی برنامه است. کنترلرها درخواست را دریافت کرده، داده‌های ورودی را اعتبارسنجی می‌کنند و متدهای مناسب از مدل‌ها را فراخوانی می‌نمایند.
    3.  **Model (`api/models/`):** لایه دسترسی به داده‌هاست. تمام کوئری‌های SQL و تعاملات با دیتابیس در این لایه انجام می‌شود.

-----

## ۴. ساختار فایل‌ها و تشریح نقش هر فایل

### الف) ساختار فرانت‌اند

```
/ (root)
|-- index.html
|-- style.css
|-- js/
|   |-- app.js
|   |-- api.js
|   |-- auth.js
|   |-- config.js
|   |-- dashboard.js
|   |-- entity-manager.js
|   |-- invoice-manager.js
|   |-- partner-manager.js
|   |-- account-manager.js
|   |-- reports.js
|   |-- ui.js
```

  * **`index.html`**: فایل اصلی که ساختار کلی UI، تمام تب‌ها، مودال‌ها و جداول را در خود دارد. تمام فایل‌های JS و CSS در این فایل بارگذاری می‌شوند.
  * **`style.css`**: شامل تمام استایل‌های سفارشی برنامه.
  * **`js/config.js`**: شامل تنظیمات ثابت جاوا اسکریپت مانند آدرس API، وضعیت اولیه جداول برای صفحه‌بندی و لیست دسته‌بندی هزینه‌ها.
  * **`js/api.js`**: یک ماژول برای مدیریت تمام تماس‌های AJAX (fetch) به بک‌اند.
  * **`js/ui.js`**: شامل توابع کمکی برای رابط کاربری، مانند نمایش/مخفی کردن لودر، فرمت‌دهی ارز، مودال تایید حذف و قالب‌بندی اعداد در لحظه تایپ.
  * **`js/auth.js`**: مسئول تمام فرآیندهای مربوط به احراز هویت.
  * **`js/app.js`**: **ارکستریتور اصلی برنامه**. این فایل تمام ماژول‌های دیگر را مقداردهی اولیه کرده، `appCache` (شامل لیست مشتریان، حساب‌ها و...) را مدیریت می‌کند و رویدادهای اصلی مانند کلیک روی تب‌ها را کنترل می‌نماید.
  * **`js/dashboard.js`**: منطق مربوط به بارگذاری و نمایش داده‌ها در تب داشبورد.
  * **`js/entity-manager.js`**: یک ماژول **عمومی** و هوشمند برای مدیریت موجودیت‌های ساده (مشتریان، تامین‌کنندگان، محصولات، هزینه‌ها و...).
  * **`js/partner-manager.js`**: ماژول اختصاصی برای تب "شرکا" که قابلیت ویرایش تراکنش‌ها را نیز مدیریت می‌کند.
  * **`js/account-manager.js`**: ماژول اختصاصی برای تب "بانک‌ها و صندوق". مسئولیت نمایش لیست حساب‌ها و گردش حساب هر کدام را بر عهده دارد.
  * **`js/invoice-manager.js`**: **پیچیده‌ترین ماژول فرانت‌اند**. مسئول تمام منطق مربوط به فاکتورهای خرید و فروش، از جمله مدیریت مودال‌ها، فیلد تخفیف، انتخاب حساب برای پرداخت‌های نقدی و استفاده از `select2` برای انتخاب اشخاص و محصولات.
  * **`js/reports.js`**: ماژول مستقل برای تولید و چاپ گزارشات مالی، شامل گزارش سود و زیان پیشرفته و صورتحساب اشخاص و بانک‌ها.

### ب) ساختار بک‌اند

```
/ (root)
|-- api.php
|-- api/
|   |-- index.php
|   |-- config.php
|   |-- core/
|   |   |-- helpers.php
|   |-- controllers/
|   |   |-- AuthController.php
|   |   |-- DataController.php
|   |   |-- EntityController.php
|   |   |-- InvoiceController.php
|   |   |-- PartnerController.php
|   |   |-- AccountController.php
|   |   |-- CheckController.php
|   |-- models/
|       |-- BaseModel.php
|       |-- (Customer.php, Supplier.php, Account.php, etc.)
```

  * **`api.php`**: فایل سازگاری که تمام درخواست‌ها را به روتر اصلی هدایت می‌کند.
  * **`api/index.php` (روتر)**: قلب بک‌اند که درخواست‌ها را به `Controller` مناسب مسیردهی می‌کند.
  * **پوشه `api/controllers/`**:
      * **`EntityController.php`**: کنترلر عمومی برای موجودیت‌های ساده.
      * **`InvoiceController.php`, `PartnerController.php`, `AccountController.php`, `CheckController.php`**: کنترلرهای اختصاصی برای مدیریت منطق پیچیده‌تر هر بخش.
  * **پوشه `api/models/`**:
      * **`BaseModel.php`**: یک کلاس پایه که منطق مشترک دیتابیس (صفحه‌بندی، حذف با مدیریت خطا) را در خود دارد.
      * **سایر فایل‌های مدل**: هر فایل مسئولیت تعامل با جدول مربوط به خود را دارد. مدل‌های مهم مانند `Invoice.php`، `Expense.php` و `Partner.php` منطق مربوط به بروزرسانی موجودی حساب‌ها (`Account->updateBalance`) را نیز در خود دارند.

-----

## ۵. جریان یک درخواست (مثال: وصول یک چک)

1.  **کاربر** روی دکمه "وصول چک" در جدول مدیریت چک‌ها کلیک می‌کند.
2.  **`app.js`**: رویداد کلیک را شناسایی کرده، مودال وصول چک (`cashCheckModal`) را باز می‌کند و لیست حساب‌ها را در آن قرار می‌دهد.
3.  **کاربر** حساب مقصد را انتخاب و دکمه "ثبت وصول" را کلیک می‌کند.
4.  **`app.js`**: اطلاعات فرم (شناسه چک و شناسه حساب) را جمع‌آوری می‌کند.
5.  **`api.js`**: یک درخواست `POST` به `api.php?action=cash_check` ارسال می‌کند.
6.  **`api/index.php` (روتر)**: درخواست را به متد `cash` در `CheckController` مسیردهی می‌کند.
7.  **`api/controllers/CheckController.php`**: متد `cashCheck` را از مدل `Check.php` فراخوانی می‌کند.
8.  **`api/models/Check.php`**:
      * وضعیت چک را در جدول `checks` به `cashed` تغییر می‌دهد.
      * شناسه حساب مقصد را در ستون `cashed_in_account_id` ثبت می‌کند.
      * متد `updateBalance` را از مدل `Account.php` فراخوانی کرده و مبلغ چک را به موجودی حساب مقصد اضافه می‌کند.
      * تمام این عملیات در یک **تراکنش (Transaction)** دیتابیس انجام می‌شود تا از صحت داده‌ها اطمینان حاصل شود.
9.  **بازگشت پاسخ**: نتیجه موفقیت‌آمیز به صورت JSON به کلاینت بازگردانده می‌شود.
10. **`app.js`**: مودال را بسته و درخواست بارگذاری مجدد لیست چک‌ها و لیست حساب‌ها را ارسال می‌کند تا کاربر تغییرات را مشاهده کند.